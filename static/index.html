<html>
  <head>
    <style type="text/css">
      body{
        background: #2d2d2d;
      }
      .vizceral-notice{
        position: absolute;
        background: rgba(255,255,255,.5);
        font-family: sans-serif;
        padding: 10px;
        font-size: 14;
      }
    </style>
    <script src="/node_modules/vizceral/dist/vizceral.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
    <script>
      function run () {
        var viz = new Vizceral.default(document.getElementById('vizceral'));
        viz.setView();
        viz.animate();

        function updateData(){
           fetch('/graph').then(function(res){
            res.json().then(function(data){
              viz.updateData(convertToVizceral(data))
            });
          })
          setTimeout(updateData,5000)
        }
        updateData();

      }

      function isNode(graph,serviceId){
        return !!_(graph.nodes).findWhere({name:serviceId})
      }

      function convertToVizceral(rawData){
        var data = {
          name: 'us-west-2',
          renderer: 'region',
          maxVolume: 10000,
          connections: []
        }

        data.nodes = _(rawData).map(function(value,key){
          var n =  {name:key}
          return n;
        })

        data.nodes.push({
          name:'INTERNET'
        })

        _(rawData).each(function(value,key){
          _(value.targets).each(function(targetValue,targetKey){
            var connections = {source:key, target:targetKey,
                metrics: {
                  normal:targetValue.requestcount ,
                  danger:targetValue.errorcount
                },

                metadata: { streaming: true }
              }

            var totalRequests = targetValue.requestcount + targetValue.errorcount;

            var severity = 0;
            if (targetValue.errorcount > 0){
              severity = 2;
            }

            if (severity == 0){
              if (totalRequests > 30 ){
                severity = 1;
              }
            }

            if (totalRequests > 8 || severity > 0){
              connections.notices = [{
                  title:'requestcount: ' + targetValue.requestcount + ', errorcount: ' + targetValue.errorcount,
                  severity: severity
                }]
            }
            data.connections.push( connections )
            if (!isNode(data,targetKey)){
              data.nodes.push({name:targetKey})
            }
          })

        })

        data.connections.push({
          source:'INTERNET', target:'portal-defensoria-gateway'
        })


        data.connections.push({
          source:'INTERNET', target:'portal-defensoria'
        })

        return data;

      }
    </script>
    <title>Vizceral Monitor Portal Defensoria</title>
  </head>
  <body onload='run()'>
    <canvas id='vizceral'></canvas>
    <div class="vizceral-notice"></div>
  </body>
</html>
